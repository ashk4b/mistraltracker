<!DOCTYPE html>
<html lang="fr" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MistralTracker - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --card-bg-light: #ffffff;
            --card-bg-dark: #212529;
            --main-bg-light: #f3f4f6;
            --main-bg-dark: #121212;
            --footer-bg-light: #e9ecef;
            --footer-bg-dark: #1a1d20;
            --nav-dark-blue: #0a192f; /* Bleu nuit demandé */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg-light);
            transition: background-color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        [data-bs-theme="dark"] body {
            background-color: var(--main-bg-dark);
        }

        /* Navbar Dark Mode spécifique */
        [data-bs-theme="dark"] .navbar {
            background-color: var(--nav-dark-blue) !important;
        }

        /* Cartes */
        .weather-card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            overflow: hidden;
            background-color: var(--bs-body-bg);
        }

        .weather-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Notifications */
        .notification-btn { position: relative; }
        .notification-badge {
            position: absolute;
            top: 0; right: 0;
            transform: translate(50%, -25%);
            font-size: 0.65rem;
        }

        /* Dark Mode Carte Leaflet */
        [data-bs-theme="dark"] .leaflet-layer,
        [data-bs-theme="dark"] .leaflet-control-zoom-in,
        [data-bs-theme="dark"] .leaflet-control-zoom-out,
        [data-bs-theme="dark"] .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        [data-bs-theme="dark"] .leaflet-popup-content-wrapper,
        [data-bs-theme="dark"] .leaflet-popup-tip {
            background-color: #2c3034; color: #fff;
        }

        /* Footer */
        footer { background-color: var(--footer-bg-light); margin-top: auto; }
        [data-bs-theme="dark"] footer { background-color: var(--footer-bg-dark); border-top: 1px solid #2c3034; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top bg-primary navbar-dark shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">
            <i class="fa-solid fa-wind me-2"></i>MistralTracker
        </a>

        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-light border-0" id="theme-toggle" title="Changer de thème">
                <i class="fa-solid fa-moon"></i>
            </button>
            <button class="btn btn-outline-light border-0 notification-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#notifCanvas">
                <i class="fa-solid fa-bell"></i>
                <span class="badge rounded-pill bg-danger notification-badge" id="notif-count" style="display: none;">0</span>
            </button>
            <a href="/logout" class="btn btn-light btn-sm rounded-pill px-3 fw-bold text-primary">
                <i class="fa-solid fa-right-from-bracket me-1"></i> Sortir
            </a>
        </div>
    </div>
</nav>

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Station Plages du Prado</h2>
            <p class="text-muted small mb-0" id="last-update-text">Connexion en cours...</p>
        </div>
        <div class="spinner-border text-primary spinner-sm" role="status" id="loading-spinner"></div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card weather-card activity-card text-center p-3" id="card-boating">
                <div class="mb-2"><i class="fa-solid fa-sailboat fa-2x text-secondary"></i></div>
                <h6 class="fw-bold text-muted mb-1">Bateau</h6>
                <span class="badge rounded-pill bg-secondary" id="badge-boating">--</span>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card weather-card activity-card text-center p-3" id="card-fishing">
                <div class="mb-2"><i class="fa-solid fa-fish fa-2x text-secondary"></i></div>
                <h6 class="fw-bold text-muted mb-1">Pêche</h6>
                <span class="badge rounded-pill bg-secondary" id="badge-fishing">--</span>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card weather-card activity-card text-center p-3" id="card-swimming">
                <div class="mb-2"><i class="fa-solid fa-person-swimming fa-2x text-secondary"></i></div>
                <h6 class="fw-bold text-muted mb-1">Baignade</h6>
                <span class="badge rounded-pill bg-secondary" id="badge-swimming">--</span>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card weather-card activity-card text-center p-3" id="card-sport">
                <div class="mb-2"><i class="fa-solid fa-water fa-2x text-secondary"></i></div>
                <h6 class="fw-bold text-muted mb-1">Sport d'eau</h6>
                <span class="badge rounded-pill bg-secondary" id="badge-sport">--</span>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card weather-card p-3">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-box bg-warning bg-opacity-10 text-warning me-3">
                        <i class="fa-solid fa-temperature-half"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Température</h6>
                        <h3 class="fw-bold mb-0"><span id="val-temp">--</span>°C</h3>
                    </div>
                </div>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Humidité</span>
                    <span class="fw-bold"><span id="val-hum">--</span>%</span>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-info" id="prog-hum" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card weather-card p-3">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-box bg-info bg-opacity-10 text-info me-3">
                        <i class="fa-solid fa-wind"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Vent</h6>
                        <h3 class="fw-bold mb-0"><span id="val-wind">--</span> <small class="fs-6 text-muted">km/h</small></h3>
                    </div>
                </div>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Direction</span>
                    <span class="fw-bold"><i class="fa-solid fa-location-arrow me-1" id="icon-dir"></i> <span id="val-dir">--</span>°</span>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card weather-card p-3">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-box bg-primary bg-opacity-10 text-primary me-3">
                        <i class="fa-solid fa-cloud-showers-heavy"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Pluie</h6>
                        <h3 class="fw-bold mb-0"><span id="val-rain">--</span> <small class="fs-6 text-muted">mm</small></h3>
                    </div>
                </div>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Pression</span>
                    <span class="fw-bold"><span id="val-pres">--</span> hPa</span>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card weather-card p-3">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-box bg-danger bg-opacity-10 text-danger me-3">
                        <i class="fa-solid fa-sun"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Indice UV</h6>
                        <h3 class="fw-bold mb-0" id="val-uv">--</h3>
                    </div>
                </div>
                <div class="d-flex justify-content-between small text-muted mb-1">
                    <span id="uv-desc">--</span>
                    <span id="val-light">-- Lux</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" id="prog-uv" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #4cd964, #ffcc00, #ff3b30);"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card weather-card p-0" style="height: 400px; position: relative; z-index: 1;">
                <div id="map" style="height: 100%; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<footer class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-4 col-md-6">
                <h5 class="fw-bold mb-3"><i class="fa-solid fa-wind me-2"></i>MistralTracker</h5>
                <p class="text-muted small">
                    Solution IoT de surveillance météo hyper-locale pour la sécurité maritime et côtière.
                    Anticipez les risques grâce aux données temps réel.
                </p>
            </div>
            <div class="col-lg-4 col-md-6">
                <h6 class="fw-bold text-uppercase mb-3">Support Technique</h6>
                <ul class="list-unstyled text-muted small">
                    <li class="mb-2"><i class="fa-solid fa-envelope me-2"></i> support@mistraltracker.com</li>
                    <li class="mb-2"><i class="fa-solid fa-phone me-2"></i> +33 4 91 00 00 00</li>
                    <li class="mb-2"><i class="fa-solid fa-location-dot me-2"></i> Marseille, France</li>
                </ul>
            </div>
            <div class="col-lg-4 col-md-12">
                <h6 class="fw-bold text-uppercase mb-3">Nos Offres d'Abonnement</h6>
                <ul class="list-group list-group-flush rounded-3 small">
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        Loisirs & Clubs
                        <span class="badge bg-primary rounded-pill">35 €/mois</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        Collectivités & Plages
                        <span class="badge bg-primary rounded-pill">70 €/mois</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        Ports & Professionnels
                        <span class="badge bg-primary rounded-pill">110 €/mois</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="border-top mt-4 pt-3 text-center text-muted small">
            <p class="mb-0">&copy; 2026 MistralTracker. Projet IoT - Tous droits réservés.</p>
        </div>
    </div>
</footer>

<div class="offcanvas offcanvas-end" tabindex="-1" id="notifCanvas" aria-labelledby="notifLabel">
    <div class="offcanvas-header bg-light border-bottom">
        <h5 class="offcanvas-title fw-bold" id="notifLabel"><i class="fa-solid fa-clock-rotate-left me-2"></i>Historique</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="p-3 bg-warning bg-opacity-10 border-bottom">
            <div class="d-grid gap-2">
                <button onclick="simulateStorm()" class="btn btn-warning btn-sm fw-bold">
                    <i class="fa-solid fa-bolt me-2"></i>Simuler Tempête (85 km/h)
                </button>
                <button onclick="fetchData()" class="btn btn-outline-secondary btn-sm">
                    <i class="fa-solid fa-rotate-right me-2"></i>Retour au direct
                </button>
            </div>
        </div>
        <div class="list-group list-group-flush" id="notif-list">
            <div class="text-center p-4 text-muted"><small>Aucune notification récente.</small></div>
        </div>
    </div>
    <div class="p-3 border-top">
        <button class="btn btn-outline-danger w-100 btn-sm" onclick="clearNotifications()">Effacer l'historique</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    const API_URL = '/api/mistraltracker/current';
    let previousState = {};

    // 1. Thème
    const themeToggleBtn = document.getElementById('theme-toggle');
    const htmlElement = document.documentElement;
    const iconTheme = themeToggleBtn.querySelector('i');
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = htmlElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
    });

    function setTheme(theme) {
        htmlElement.setAttribute('data-bs-theme', theme);
        localStorage.setItem('theme', theme);
        iconTheme.className = theme === 'light' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
    }

    // 2. Carte Leaflet
    const stationLat = 43.2515;
    const stationLng = 5.3745;
    const map = L.map('map').setView([stationLat, stationLng], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const weatherIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/4052/4052984.png',
        iconSize: [45, 45], iconAnchor: [22, 45], popupAnchor: [0, -40]
    });
    const marker = L.marker([stationLat, stationLng], {icon: weatherIcon}).addTo(map);
    marker.bindPopup("<b>Chargement...</b>"); // Pas de .openPopup() ici
    setTimeout(() => { map.invalidateSize(); }, 500);

    // 3. Notifications & Heure
    function getRoundedTime() {
        const now = new Date();
        now.setMinutes(Math.round(now.getMinutes() / 10) * 10);
        return now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function addNotification(message, type = 'info') {
        const list = document.getElementById('notif-list');
        let iconClass = 'text-primary fa-circle-info';
        if (type === 'success') iconClass = 'text-success fa-check-circle';
        if (type === 'danger') iconClass = 'text-danger fa-triangle-exclamation';

        const item = `
            <div class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
                <i class="fa-solid ${iconClass} fs-5 mt-1"></i>
                <div class="d-flex gap-2 w-100 justify-content-between">
                    <div><p class="mb-0 opacity-75 fw-medium">${message}</p></div>
                    <small class="opacity-50 text-nowrap">${getRoundedTime()}</small>
                </div>
            </div>`;

        if (list.innerText.includes('Aucune notification')) list.innerHTML = '';
        list.insertAdjacentHTML('afterbegin', item);
        saveNotifications();
        updateNotifBadge();
    }

    function saveNotifications() { localStorage.setItem('notifications', document.getElementById('notif-list').innerHTML); }
    function loadNotifications() {
        const saved = localStorage.getItem('notifications');
        if (saved) document.getElementById('notif-list').innerHTML = saved;
    }
    function clearNotifications() {
        localStorage.removeItem('notifications');
        document.getElementById('notif-list').innerHTML = '<div class="text-center p-4 text-muted"><small>Aucune notification récente.</small></div>';
        document.getElementById('notif-count').style.display = 'none';
    }
    function updateNotifBadge() {
        const badge = document.getElementById('notif-count');
        badge.style.display = 'inline-block';
        badge.innerText = 'New';
    }

    // 4. Data Fetching
    async function fetchData() {
        const spinner = document.getElementById('loading-spinner');
        spinner.style.display = 'block';
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Erreur API');
            const data = await response.json();
            updateDashboard(data);
            checkChangesAndNotify(data);
            previousState = data;
        } catch (error) {
            console.error(error);
            document.getElementById('last-update-text').innerText = "Erreur de connexion";
            document.getElementById('last-update-text').className = "text-danger small mb-0";
        } finally { spinner.style.display = 'none'; }
    }

    function updateDashboard(data) {
        const dateObj = new Date(data.timestamp || Date.now());
        const timeStr = dateObj.toLocaleTimeString();
        document.getElementById('last-update-text').innerText = "Dernier relevé : " + timeStr;

        safeText('val-temp', data.temperature);
        safeText('val-hum', data.humidity);
        safeText('val-wind', data.windSpeed);
        safeText('val-dir', data.windDirection);
        safeText('val-rain', data.rainLevel);

        if (data.pressure) document.getElementById('val-pres').innerText = (data.pressure / 100).toFixed(0);

        let uvVal = data.uvIntensity !== null ? data.uvIntensity : 0;
        document.getElementById('val-uv').innerText = uvVal;
        document.getElementById('val-light').innerText = (data.lightIntensity || 0) + " Lux";

        let uvDesc = "Faible";
        if (uvVal >= 3) uvDesc = "Modéré";
        if (uvVal >= 6) uvDesc = "Élevé";
        if (uvVal >= 8) uvDesc = "Très Élevé";
        if (uvVal >= 11) uvDesc = "Extrême";
        document.getElementById('uv-desc').innerText = uvDesc;

        document.getElementById('prog-hum').style.width = (data.humidity || 0) + "%";
        let uvPercent = Math.min((uvVal / 11) * 100, 100);
        document.getElementById('prog-uv').style.width = uvPercent + "%";

        if (data.windDirection) {
            document.getElementById('icon-dir').style.transform = `rotate(${data.windDirection}deg)`;
        }

        setActivity('boating', data.goodForBoating);
        setActivity('fishing', data.goodForFishing);
        setActivity('swimming', data.goodForSwimming);
        setActivity('sport', data.goodForWaterSports);

        const popupContent = `
            <div class="text-center">
                <h6 class="fw-bold mb-1">Station Prado</h6>
                <div class="mb-2"><i class="fa-solid fa-tower-cell text-primary"></i></div>
                <div class="text-start small">
                     <span class="text-muted">Device EUI:</span><br>
                     <b class="text-primary">${data.deviceEui || 'Inconnu'}</b>
                     <hr class="my-1">
                     <span class="text-muted">Dernier signal:</span><br>
                     <b>${timeStr}</b>
                </div>
            </div>`;
        marker.setPopupContent(popupContent);
    }

    function safeText(id, val) { document.getElementById(id).innerText = val !== null ? val : '--'; }

    function setActivity(id, isGood) {
        const badge = document.getElementById('badge-' + id);
        const icon = document.querySelector(`#card-${id} i`);
        badge.className = 'badge rounded-pill';
        icon.className = icon.className.replace('text-success', 'text-secondary').replace('text-danger', 'text-secondary');

        if (isGood) {
            badge.classList.add('bg-success'); badge.innerText = 'Favorable';
            icon.classList.remove('text-secondary'); icon.classList.add('text-success');
        } else {
            badge.classList.add('bg-danger'); badge.innerText = 'Défavorable';
        }
    }

    function checkChangesAndNotify(data) {
        const isFirstLoad = !previousState.id;
        if (isFirstLoad) {
            addNotification("Système initialisé : Station Prado en ligne.", "info");
            return;
        }

        if (data.goodForFishing !== previousState.goodForFishing) {
            const msg = data.goodForFishing ? "Pêche à nouveau favorable." : "Alerte : Conditions de pêche dégradées.";
            addNotification(msg, data.goodForFishing ? 'success' : 'danger');
        }
        if (data.windSpeed > 80 && previousState.windSpeed <= 80) {
            addNotification("ALERTE ROUGE : Rafales > 80 km/h. Évacuation requise.", "danger");
        }
    }

    // --- 5. LOGIQUE DE SIMULATION COHÉRENTE ---
    function simulateStorm() {
        const fakeData = {
            ...previousState,
            windSpeed: 85.0, // Force 9
            rainLevel: 12.0, // Pluie intense
            pressure: 97500.0, // Chute de pression
            // SÉCURITÉ : Tout passe à FALSE
            goodForBoating: false,
            goodForFishing: false,
            goodForSwimming: false,
            goodForWaterSports: false, // Trop dangereux à 85km/h
            timestamp: new Date().toISOString()
        };

        updateDashboard(fakeData);

        // On force la notification d'alerte
        addNotification("⚠️ ALERTE TEMPÊTE : Vent 85 km/h. Toutes activités interdites.", "danger");

        // On met à jour l'état précédent pour éviter de spammer
        previousState = fakeData;
    }

    loadNotifications();
    fetchData();
    setInterval(fetchData, 30000);
</script>
</body>
</html>